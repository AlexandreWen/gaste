<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>gaste_test.stratified_table2x2 &mdash; gaste test 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=92fd9be5" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            gaste test
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Gaste test</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">gaste test</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">gaste_test.stratified_table2x2</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for gaste_test.stratified_table2x2</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">NamedTuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;..&quot;</span><span class="p">)))</span>


<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">hypergeom</span><span class="p">,</span> <span class="n">norm</span>

<span class="kn">from</span> <span class="nn">gaste_test.combined_pval</span> <span class="kn">import</span> <span class="n">get_pval_comb</span>


<span class="k">class</span> <span class="nc">_Result</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Result&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">,</span> <span class="s2">&quot;pvalue&quot;</span><span class="p">])):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents the result of a statistical test.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">        stat (float): The calculated statistic value.</span>
<span class="sd">        pvalue (float): The p-value associated with the statistic.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;statistic: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p-value: </span><span class="si">{</span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.001</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvalue</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>


<div class="viewcode-block" id="Table2x2">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.Table2x2">[docs]</a>
<span class="k">class</span> <span class="nc">Table2x2</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a 2x2 contingency table and provides various statistical calculations.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    table_data : 2D array-like representing the content of the table [[a,b],[c,d]] where `a` is the count of events in the first category, `b` is the count of non-events in the first category, `c` is the count of events in the second category, `d` is the count of non-events in the second category. Or a tuple of 4 integers (N, n, K, a) where `N` is the total count of events and non-events, `n` is the count of events in both categories, `K` is the total count in the first category, and `a` is the count of events in the first category.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    -----------</span>
<span class="sd">    a : int</span>
<span class="sd">        The count of events in the first category.</span>
<span class="sd">    b : int</span>
<span class="sd">        The count of non-events in the first category.</span>
<span class="sd">    c : int</span>
<span class="sd">        The count of events in the second category.</span>
<span class="sd">    d : int</span>
<span class="sd">        The count of non-events in the second category.</span>
<span class="sd">    N : int</span>
<span class="sd">        The total count of events and non-events (a+b+c+d).</span>
<span class="sd">    n : int</span>
<span class="sd">        The count of events in both categories (a+c).</span>
<span class="sd">    K : int</span>
<span class="sd">        The total count in the first category (a+b).</span>

<span class="sd">    Methods:</span>
<span class="sd">    --------</span>
<span class="sd">    odd_ratio()</span>
<span class="sd">        Calculates the odds ratio of the contingency table.</span>
<span class="sd">    support()</span>
<span class="sd">        Returns the range of possible support values.</span>
<span class="sd">    len_support()</span>
<span class="sd">        Returns the number of possible support values.</span>
<span class="sd">    variance_log_odd_ratio()</span>
<span class="sd">        Calculates the variance of the log odds ratio.</span>
<span class="sd">    ci_odd_ratio(alpha=0.05)</span>
<span class="sd">        Calculates the confidence interval of the odds ratio.</span>
<span class="sd">    mh_weight()</span>
<span class="sd">        Calculates the Mantel-Haenszel weight.</span>
<span class="sd">    pval_under()</span>
<span class="sd">        Calculates the p-value for observing the given count or fewer.</span>
<span class="sd">    pval_over()</span>
<span class="sd">        Calculates the p-value for observing the given count or more.</span>
<span class="sd">    support_pval_under()</span>
<span class="sd">        Calculates the p-values for observing each support value or fewer.</span>
<span class="sd">    support_pval_over()</span>
<span class="sd">        Calculates the p-values for observing each support value or more.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">table_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
        <span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">table_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">table_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">table_data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">table_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">table_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span>
        <span class="k">elif</span> <span class="n">table_data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">table_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The data should be a 2x2 table or a tuple of 4 integers.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Table2x2.odd_ratio">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.Table2x2.odd_ratio">[docs]</a>
    <span class="k">def</span> <span class="nf">odd_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the odds ratio of the contingency table.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The odds ratio.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">d</span> <span class="o">/</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span></div>


<div class="viewcode-block" id="Table2x2.support">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.Table2x2.support">[docs]</a>
    <span class="k">def</span> <span class="nf">support</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">range</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the range of possible support values.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        range</span>
<span class="sd">            The range of possible support values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="Table2x2.len_support">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.Table2x2.len_support">[docs]</a>
    <span class="k">def</span> <span class="nf">len_support</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of possible support values.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The number of possible support values.</span>

<span class="sd">        Notes:</span>
<span class="sd">        --------</span>
<span class="sd">        The type of the int return value is cast to float to avoid rounding errors during the calculation of the number of combination in Stratified2x2.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">()))</span></div>


<div class="viewcode-block" id="Table2x2.variance_log_odd_ratio">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.Table2x2.variance_log_odd_ratio">[docs]</a>
    <span class="k">def</span> <span class="nf">variance_log_odd_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the variance of the log odds ratio.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The variance of the log odds ratio.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">d</span></div>


<div class="viewcode-block" id="Table2x2.ci_odd_ratio">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.Table2x2.ci_odd_ratio">[docs]</a>
    <span class="k">def</span> <span class="nf">ci_odd_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the confidence interval of the odds ratio.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        alpha : float, optional</span>
<span class="sd">            The significance level (default is 0.05).</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        tuple</span>
<span class="sd">            A tuple containing the lower and upper bounds of the confidence interval.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">or_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odd_ratio</span><span class="p">()</span>
        <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variance_log_odd_ratio</span><span class="p">())</span>
        <span class="n">log_ci_inf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">or_</span><span class="p">)</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">se</span>
        <span class="n">log_ci_sup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">or_</span><span class="p">)</span> <span class="o">+</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">se</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_ci_inf</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_ci_sup</span><span class="p">)</span></div>


<div class="viewcode-block" id="Table2x2.mh_weight">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.Table2x2.mh_weight">[docs]</a>
    <span class="k">def</span> <span class="nf">mh_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the Mantel-Haenszel weight.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The Mantel-Haenszel weight.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span></div>


<div class="viewcode-block" id="Table2x2.pval_under">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.Table2x2.pval_under">[docs]</a>
    <span class="k">def</span> <span class="nf">pval_under</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the p-value for observing the given count or fewer.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The p-value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">hypergeom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span></div>


<div class="viewcode-block" id="Table2x2.pval_over">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.Table2x2.pval_over">[docs]</a>
    <span class="k">def</span> <span class="nf">pval_over</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the p-value for observing the given count or more.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The p-value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">hypergeom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="Table2x2.support_pval_under">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.Table2x2.support_pval_under">[docs]</a>
    <span class="k">def</span> <span class="nf">support_pval_under</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the p-values for observing each support value or fewer.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            An array of p-values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">hypergeom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">())</span></div>


<div class="viewcode-block" id="Table2x2.support_pval_over">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.Table2x2.support_pval_over">[docs]</a>
    <span class="k">def</span> <span class="nf">support_pval_over</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the p-values for observing each support value or more.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            An array of p-values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">hypergeom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">support</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="StratifiedTable2x2">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.StratifiedTable2x2">[docs]</a>
<span class="k">class</span> <span class="nc">StratifiedTable2x2</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This module contains the StratifiedTable2x2 class for analyzing stratified 2x2 contingency tables.</span>

<span class="sd">    :class:`StratifiedTable2x2` takes in a list of tables, labels, and optional parameters to perform various statistical tests and calculations on the tables.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">        tables (list) : A list of ndarray 2x2 representing the contingency tables. One table per stratum.</span>
<span class="sd">        labels (list) : A list of labels for each table/stratum.</span>
<span class="sd">        decimal (int) : The number of decimal places to round the results to. Default is 3.</span>
<span class="sd">        alpha (float) : The significance level for confidence intervals and hypothesis tests. Default is 0.05.</span>
<span class="sd">        name_rows (tuple) : A tuple of row names for the tables. Optional.</span>
<span class="sd">        name_columns (tuple) : A tuple of column names for the tables. Optional.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    -----------</span>
<span class="sd">        nb_combination (float) : The number of combinations for the exact calculation, int cast to float for numeric reason.</span>
<span class="sd">        odds_ratio (ndarray) : An array of odds ratios for each table.</span>
<span class="sd">        log_odds_ratio (ndarray) : An array of log odds ratios for each table.</span>
<span class="sd">        ci_odds_ratio_inf (ndarray) : An array of lower confidence intervals for odds ratios.</span>
<span class="sd">        ci_odds_ratio_sup (ndarray) : An array of upper confidence intervals for odds ratios.</span>
<span class="sd">        log_ci_odds_ratio_inf (ndarray) : An array of lower confidence intervals for log odds ratios.</span>
<span class="sd">        log_ci_odds_ratio_sup (ndarray) : An array of upper confidence intervals for log odds ratios.</span>
<span class="sd">        pval_under (ndarray) : An array of p-values for the hypothesis test of odds ratio &lt; 1.</span>
<span class="sd">        pval_over (ndarray) : An array of p-values for the hypothesis test of odds ratio &gt; 1.</span>
<span class="sd">        weight (ndarray) : An array of weights for each table.</span>
<span class="sd">        odds_ratio_pooled (float) : The pooled odds ratio.</span>
<span class="sd">        df (DataFrame) : A pandas DataFrame containing the results of the analysis and data.</span>

<span class="sd">    Methods:</span>
<span class="sd">    --------</span>
<span class="sd">        __init__(tables, labels, decimal=3, alpha=0.05, name_rows=None, name_columns=None):</span>
<span class="sd">            Initializes a StratifiedTable2x2 object with the given parameters.</span>
<span class="sd">        gaste(alternative=&#39;less&#39;, tau=1, limit_computation_exact=10**7, verbose=True, moment=2, jobs=None):</span>
<span class="sd">            Performs the GASTE test on the tables.</span>
<span class="sd">        pool_odd_ratio():</span>
<span class="sd">            Calculates the pooled odds ratio.</span>
<span class="sd">        pool_ci_odd_ratio():</span>
<span class="sd">            Calculates the confidence interval for the pooled odds ratio.</span>
<span class="sd">        CMH_test(correction=False):</span>
<span class="sd">            Performs the Cochran-Mantel-Haenszel test on the tables.</span>
<span class="sd">        BD_test(adjust=False):</span>
<span class="sd">            Performs the Breslow-Day test for homogeneity of odds ratios.</span>
<span class="sd">        resume():</span>
<span class="sd">            Prints a summary of the analysis results.</span>
<span class="sd">        plot(log_scale=True, fontsize=12, thresh_adjust=0.03, y_figsize=None, save=None):</span>
<span class="sd">            Plots a forest plot with odds ratios, confidence intervals and resume of data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]],</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">decimal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="n">name_rows</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name_columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO include different way to give tables</span>
        <span class="c1"># TODO include random effect model and different method than MH</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="n">Table2x2</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Stratum </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decimal</span> <span class="o">=</span> <span class="n">decimal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ai</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">a</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">b</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">c</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">di</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">d</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">N</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ai</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ki</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ai</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Ni</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ni</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ki</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_rows</span> <span class="o">=</span> <span class="n">name_rows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_columns</span> <span class="o">=</span> <span class="n">name_columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_combination</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">len_support</span><span class="p">())</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">odds_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">odd_ratio</span><span class="p">()</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_odds_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odds_ratio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_odds_ratio_inf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_odds_ratio_sup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">ci_odd_ratio</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_odds_ratio_print</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">ci_inf</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="p">)</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">ci_sup</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="p">)</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="k">for</span> <span class="n">ci_inf</span><span class="p">,</span> <span class="n">ci_sup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ci_odds_ratio_inf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_odds_ratio_sup</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_ci_odds_ratio_inf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ci_odds_ratio_inf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_ci_odds_ratio_sup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ci_odds_ratio_sup</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_ci_odd_ratio_print</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">ci_inf</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="p">)</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">ci_sup</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="p">)</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="k">for</span> <span class="n">ci_inf</span><span class="p">,</span> <span class="n">ci_sup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_ci_odds_ratio_inf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_ci_odds_ratio_sup</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pval_under</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">pval_under</span><span class="p">()</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pval_over</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">pval_over</span><span class="p">()</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">mh_weight</span><span class="p">()</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">odds_ratio_pooled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_odd_ratio</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Studies&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s2">&quot;$k_i$&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="p">,</span>
                <span class="s2">&quot;$K_i-k_i$&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bi</span><span class="p">,</span>
                <span class="s2">&quot;$n_i-k_i$&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci</span><span class="p">,</span>
                <span class="s2">&quot;$N_i-n_i$</span><span class="se">\n</span><span class="s2">$-K_i+k_i$&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">di</span><span class="p">,</span>
                <span class="s2">&quot;$p_i^-$&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pval_under</span><span class="p">,</span>
                <span class="s2">&quot;$p_i^+$&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pval_over</span><span class="p">,</span>
                <span class="s2">&quot;OR&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">odds_ratio</span><span class="p">,</span>
                <span class="s2">&quot;log(OR)&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_odds_ratio</span><span class="p">,</span>
                <span class="s2">&quot;CI&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_odds_ratio_print</span><span class="p">,</span>
                <span class="s2">&quot;log(CI)&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_ci_odd_ratio_print</span><span class="p">,</span>
                <span class="s2">&quot;%W(fixed)&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Studies&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;OR&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="p">,</span> <span class="s2">&quot;log(OR)&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_rows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">row1</span><span class="p">,</span> <span class="n">row2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_rows</span>
            <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_columns</span>
            <span class="n">dict_rename</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;$k_i$&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;$K_i-k_i$&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;$n_i-k_i$&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;$N_i-n_i$</span><span class="se">\n</span><span class="s2">$-K_i+k_i$&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">dict_rename</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name_columns_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict_rename</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name_columns_data</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;$k_i$&quot;</span><span class="p">,</span>
                <span class="s2">&quot;$K_i-k_i$&quot;</span><span class="p">,</span>
                <span class="s2">&quot;$n_i-k_i$&quot;</span><span class="p">,</span>
                <span class="s2">&quot;$N_i-n_i$</span><span class="se">\n</span><span class="s2">$-K_i+k_i$&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combined_pval_less</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combined_pval_greater</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="StratifiedTable2x2.gaste">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.StratifiedTable2x2.gaste">[docs]</a>
    <span class="k">def</span> <span class="nf">gaste</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">alternative</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;less&quot;</span><span class="p">,</span>
        <span class="n">tau</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">limit_computation_exact</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="mi">7</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">moment</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NamedTuple</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the GASTE (Gamma Approximation of Stratified Troncated Exact) test to test the overall association between features and outcome in 2x2 stratified table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alternative : {&#39;less&#39;, &#39;greater&#39;}, optional</span>
<span class="sd">            The alternative hypothesis. Default is &quot;less&quot;.</span>

<span class="sd">            * &#39;less&#39;: compute the combined p-value of one-sided `less` Fisher exact test of each stratum to test overall under-association.</span>
<span class="sd">            * &#39;greater&#39;: compute the combined p-value of one-sided `greater` Fisher exact test of each stratum to test overall over-association.</span>

<span class="sd">            See the Notes for more details.</span>

<span class="sd">        tau : int or float, optional</span>
<span class="sd">            The truncation value used in GASTE. Default is 1.</span>
<span class="sd">        limit_computation_exact : int, optional</span>
<span class="sd">            The limit for exact computation of the combined p-value. Default is 10^7.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print verbose output during computation. Default is True.</span>
<span class="sd">        moment : int, optional</span>
<span class="sd">            The moment to use for the approximation of the combined p-value. Default is 2.</span>
<span class="sd">        jobs : int or None, optional</span>
<span class="sd">            The number of parallel jobs to use for computation. Default is None, all core is used.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : Result</span>
<span class="sd">            A named tuple containing attributes :</span>
<span class="sd">                stat : float</span>
<span class="sd">                    It&#39;s the value of the combination of p-value of observed data in each strat.</span>
<span class="sd">                pvalue : float</span>
<span class="sd">                    The combined p-value resulting from the GASTE test.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the `alternative` parameter is not &quot;less&quot; or &quot;greater&quot;.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        combined_pval.get_pval_comb : The function that computes the combined p-value.</span>


<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        The GASTE statistic is computed as :math:`Y_{\tau} = -2\sum_{i=1}^I \left(\log(P_i) - \log(\tau)\right)\mathbb{I}(P_i\leq\tau)` or each p-value in the given data.</span>

<span class="sd">        .. math::</span>
<span class="sd">            Y_{\tau} = -2\sum_{i=1}^I \left( \log(P_i) - \log(\tau)\right)\mathbb{I}(P_i\leq\tau)</span>

<span class="sd">        The combined p-value is computed exactly by exploring all possible combination of tables if the number of combination is under the limit threshold, else gamma approximation is used.</span>

<span class="sd">        If `alternative` is `less`, the combined p-value is stored in `self.combined_pval_less`.</span>
<span class="sd">        If `alternative` is `greater`, the combined p-value is stored in `self.combined_pval_greater`. So if the result is needed later in plot method or other, it can be used without recomputing it.</span>

<span class="sd">        Globaly this method call the function :py:func:`combined_pval.get_pval_comb`. See documentation for more details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Globaly this method call the function `combined_pval.get_pval_comb`_ . See documentation for more details.</span>
        <span class="c1"># \(Y_{\tau} = -2\sum_{i=1}^I \left( \log(P_i) - \log(\tau)\right)\mathbb{I}(P_i\leq\tau) \)</span>

        <span class="c1"># TODO math formula</span>
        <span class="c1"># For the overall under-association, the hypotheses are :</span>
        <span class="c1"># $$H^-_0=\cap H^-_{0_i}: &quot;\forall i, \theta_i \geq 1&quot; \text{ against } H^-_1 : &quot;\theta_i &lt; 1 \text{ for at least one stratum } i&quot;$$</span>
        <span class="c1"># Similary, for the overall over-association :</span>
        <span class="c1"># $$H^+_0=\cap H^+_{0_i}: &quot;\forall i, \theta_i \leq 1&quot; \text{ against } H^+_1 : &quot;\theta_i &gt; 1 \text{ for at least one stratum } i&quot;$$</span>
        <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span><span class="p">:</span>
            <span class="n">pvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pval_under</span>
            <span class="n">alternative</span> <span class="o">=</span> <span class="s2">&quot;under&quot;</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span><span class="p">:</span>
            <span class="n">pvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pval_over</span>
            <span class="n">alternative</span> <span class="o">=</span> <span class="s2">&quot;over&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;alternative should be &#39;less&#39; or &#39;greater&#39;&quot;</span><span class="p">)</span>
        <span class="n">gaste_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">([</span><span class="n">p</span> <span class="o">/</span> <span class="n">tau</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="n">tau</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pvals</span><span class="p">]))</span>
        <span class="n">comb_pval</span> <span class="o">=</span> <span class="n">get_pval_comb</span><span class="p">(</span>
            <span class="n">pvals</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
            <span class="n">alternative</span><span class="p">,</span>
            <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span>
            <span class="n">threshold_compute_explicite</span><span class="o">=</span><span class="n">limit_computation_exact</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">moment</span><span class="o">=</span><span class="n">moment</span><span class="p">,</span>
            <span class="n">jobs</span><span class="o">=</span><span class="n">jobs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_Result</span><span class="p">(</span><span class="n">gaste_</span><span class="p">,</span> <span class="n">comb_pval</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;under&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combined_pval_less</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combined_pval_greater</span> <span class="o">=</span> <span class="n">result</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="StratifiedTable2x2.pool_odd_ratio">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.StratifiedTable2x2.pool_odd_ratio">[docs]</a>
    <span class="k">def</span> <span class="nf">pool_odd_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the pooled odds ratio.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">            float: The pooled odds ratio.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odds_ratio</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span></div>


<div class="viewcode-block" id="StratifiedTable2x2.pool_ci_odd_ratio">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.StratifiedTable2x2.pool_ci_odd_ratio">[docs]</a>
    <span class="k">def</span> <span class="nf">pool_ci_odd_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the confidence interval for the pooled odds ratio.</span>

<span class="sd">        This method calculates the confidence interval for the pooled odds ratio using the Generalized Mantel-Haenszel estimators for K 2xJ tables.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">            tuple: A tuple containing the lower and upper bounds of the confidence interval.</span>

<span class="sd">        References:</span>
<span class="sd">        -----------</span>
<span class="sd">            - Greenland S (1989) Generalized Mantel-Haenszel estimators for K 2xJ tables. Biometrics 45(1):183-191</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pool_od</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool_odd_ratio</span><span class="p">())</span>
        <span class="n">Pi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ai</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ni</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">di</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ni</span>
        <span class="n">Qi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ni</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ni</span>
        <span class="n">Ri</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ai</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ni</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">di</span>
        <span class="n">Si</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ni</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ri</span><span class="p">)</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Si</span><span class="p">)</span>
        <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="mi">1</span>
            <span class="o">/</span> <span class="mi">2</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pi</span> <span class="o">*</span> <span class="n">Ri</span><span class="p">)</span> <span class="o">/</span> <span class="n">R</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pi</span> <span class="o">*</span> <span class="n">Si</span> <span class="o">+</span> <span class="n">Qi</span> <span class="o">*</span> <span class="n">Ri</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">R</span> <span class="o">*</span> <span class="n">S</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Qi</span> <span class="o">*</span> <span class="n">Si</span><span class="p">)</span> <span class="o">/</span> <span class="n">S</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pool_od</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">se</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="n">pool_od</span> <span class="o">+</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">se</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="StratifiedTable2x2.CMH_test">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.StratifiedTable2x2.CMH_test">[docs]</a>
    <span class="k">def</span> <span class="nf">CMH_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NamedTuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the Cochran-Mantel-Haenszel (CMH) test on a 2x2 stratified table to test the overall association between features and outcomes in 2x2 stratified table.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        correction : bool, optional</span>
<span class="sd">            Parameter to apply Yates correction for continuity. Default is False.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        result : Result</span>
<span class="sd">            A named tuple containing attributes :</span>
<span class="sd">                stat : float</span>
<span class="sd">                    The CMH test statistic</span>
<span class="sd">                pvalue : float</span>
<span class="sd">                    The p-value associated with the CMH test</span>

<span class="sd">        References:</span>
<span class="sd">        -----------</span>
<span class="sd">            - Cochran, W. G. (1954). Some methods for strengthening the common chi-squared tests. Biometrics, 10(4), 417-451.</span>
<span class="sd">            - Mantel, N., &amp; Haenszel, W. (1959). Statistical aspects of the analysis of data from retrospective studies of disease. Journal of the National Cancer Institute, 22(4), 719-748.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">correction</span><span class="p">:</span>
            <span class="n">correction</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">correction</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cmh</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ai</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ki</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ni</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ni</span><span class="p">))</span> <span class="o">-</span> <span class="n">correction</span>
        <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ki</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ni</span>
            <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">di</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ci</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">di</span><span class="p">)</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ni</span><span class="o">**</span><span class="mi">2</span>
            <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ni</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">pval</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">cmh</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_Result</span><span class="p">(</span><span class="n">cmh</span><span class="p">,</span> <span class="n">pval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="StratifiedTable2x2.BD_test">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.StratifiedTable2x2.BD_test">[docs]</a>
    <span class="k">def</span> <span class="nf">BD_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the Breslow-Day test for homogeneity of odds ratios, i.e. test that all odds ratio are equal.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        adjust : bool, optional</span>
<span class="sd">            Use the Tarone adjustment to achieve the chi^2 asymptotic distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        result : Result</span>
<span class="sd">            A named tuple containing attributes :</span>
<span class="sd">                statistic : float</span>
<span class="sd">                    The chi^2 test statistic.</span>
<span class="sd">                p-value : float</span>
<span class="sd">                    The p-value for the test.</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        The implementation is inspired by the implementation in the `statsmodels` package.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">odds_ratio_pooled</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odds_ratio_pooled</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ki</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ni</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">di</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">odds_ratio_pooled</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ki</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ni</span>

        <span class="c1"># Expected value of first cell</span>
        <span class="n">e_ki</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>

        <span class="c1"># Variance of the first cell</span>
        <span class="n">v_ki</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">1</span> <span class="o">/</span> <span class="n">e_ki</span>
            <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ni</span> <span class="o">-</span> <span class="n">e_ki</span><span class="p">)</span>
            <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ki</span> <span class="o">-</span> <span class="n">e_ki</span><span class="p">)</span>
            <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">di</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ai</span> <span class="o">+</span> <span class="n">e_ki</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">v_ki</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">v_ki</span>

        <span class="n">bd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ai</span> <span class="o">-</span> <span class="n">e_ki</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">v_ki</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">adjust</span><span class="p">:</span>
            <span class="n">adj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ai</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_ki</span><span class="p">)</span>
            <span class="n">adj</span> <span class="o">=</span> <span class="n">adj</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">adj</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v_ki</span><span class="p">)</span>
            <span class="n">bd</span> <span class="o">-=</span> <span class="n">adj</span>

        <span class="n">pval</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">bd</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_Result</span><span class="p">(</span><span class="n">bd</span><span class="p">,</span> <span class="n">pval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="StratifiedTable2x2.resume">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.StratifiedTable2x2.resume">[docs]</a>
    <span class="k">def</span> <span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print the DataFrame containing the data, the odd ration and ci of each stratum, pooled odd ratio with MH method, and the confident interval of the pooled odd ratio.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ci_inf</span><span class="p">,</span> <span class="n">ci_sup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_ci_odd_ratio</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Pooled odd ratio with MH method : &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool_odd_ratio</span><span class="p">(),</span> <span class="mi">4</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Confident interval at </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">% of pooled odd ratio : (</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">ci_inf</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">ci_sup</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="StratifiedTable2x2.plot">
<a class="viewcode-back" href="../../stratified_table2x2.html#gaste_test.stratified_table2x2.StratifiedTable2x2.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">log_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
        <span class="n">thresh_adjust</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span>
        <span class="n">y_figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">save</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a forest plot with odds ratios, confidence intervals and resume of data on each side of the CI odd ratio plot. The plot is annotated with the CMH test, BD test, and GASTE test results.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        log_scale : bool, optional</span>
<span class="sd">            Whether to use a logarithmic scale for the x-axis, so use odd ratio or log odd ratio. Default is True.</span>
<span class="sd">        fontsize : int, optional</span>
<span class="sd">            The font size for the plot. Default is 12.</span>
<span class="sd">        thresh_adjust : float, optional</span>
<span class="sd">            The adjustment value for the figure on y-axis to align confident interval result with data on each side. If you have only 2 or 3 strata, a value of 0.1 is advise. Else, if you have more than 10 strata, a smaller value like 0.001 is advise. Default is 0.03.</span>
<span class="sd">        y_figsize : float, optional</span>
<span class="sd">            The figure size for the y-axis. Default is None and set automatically based on the number of strata.</span>
<span class="sd">        save : str, optional</span>
<span class="sd">            The file path to save the plot, a png and svg file will be create. Default is None.</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        At the end `show` is not called, so you can use `plt.show()` to display the plot. But there is an issue with the x-axis size of the display due to the use of annotation to show some information on each side of the CI odd ratio plot. So the option `save` is recommended to save and display the plot, or the use of Jupiter notebook avoid this issue.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">y_figsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_figsize</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">6</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.2</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.8</span><span class="p">,</span> <span class="n">y_figsize</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">log_scale</span><span class="p">:</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odds_ratio</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ci_odds_ratio_inf</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ci_odds_ratio_sup</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odds_ratio</span><span class="p">),</span>
            <span class="p">]</span>
            <span class="n">odds_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odds_ratio</span><span class="p">)</span>
            <span class="n">ci_pool_odd_ratio_inf</span><span class="p">,</span> <span class="n">ci_pool_odd_ratio_sup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool_ci_odd_ratio</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">pool_odd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odds_ratio_pooled</span><span class="p">)</span>
            <span class="n">center_val</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">print_theta</span> <span class="o">=</span> <span class="s2">&quot;\log(</span><span class="se">\\</span><span class="s2">theta)&quot;</span>
            <span class="n">print_theta_i</span> <span class="o">=</span> <span class="s2">&quot;\log(</span><span class="se">\\</span><span class="s2">theta_i)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">odds_ratio</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_odds_ratio_inf</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ci_odds_ratio_sup</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">odds_ratio</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">odds_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odds_ratio</span>
            <span class="n">ci_pool_odd_ratio_inf</span><span class="p">,</span> <span class="n">ci_pool_odd_ratio_sup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_ci_odd_ratio</span><span class="p">()</span>
            <span class="n">pool_odd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odds_ratio_pooled</span>
            <span class="n">center_val</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">print_theta</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">theta&quot;</span>
            <span class="n">print_theta_i</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">theta_i&quot;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
            <span class="n">odds_ratio</span><span class="p">,</span>
            <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">xerr</span><span class="o">=</span><span class="n">xerr</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">ecolor</span><span class="o">=</span><span class="s2">&quot;dimgrey&quot;</span><span class="p">,</span>
            <span class="n">elinewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">size_marker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">7</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">odds_ratio</span><span class="p">,</span>
            <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="n">size_marker</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
            <span class="n">Polygon</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">[</span><span class="n">ci_pool_odd_ratio_inf</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">pool_odd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">4</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">ci_pool_odd_ratio_sup</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">pool_odd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">4</span><span class="p">],</span>
                <span class="p">],</span>
                <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">1.6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="n">thresh_adjust</span><span class="p">),</span>
            <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">1.6</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="n">thresh_adjust</span><span class="p">),</span>
            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">cmh</span><span class="p">,</span> <span class="n">cmh_pval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CMH_test</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="sa">rf</span><span class="s2">&quot;FE Model $\bf</span><span class="se">{{</span><span class="s2">Overall\,effect\, CMH</span><span class="se">}}</span><span class="s2">$, test of $</span><span class="si">{</span><span class="n">print_theta</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">center_val</span><span class="si">}</span><span class="s2">$, CMH=</span><span class="si">{</span><span class="n">cmh</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> $\bf</span><span class="se">{{</span><span class="s2">p=</span><span class="si">{</span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.001</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)(</span><span class="n">cmh_pval</span><span class="p">)</span><span class="si">}</span><span class="se">}}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">thresh_adjust</span><span class="p">),</span>
            <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">bd</span><span class="p">,</span> <span class="n">bd_pval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BD_test</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="sa">rf</span><span class="s2">&quot;Test for $\bf</span><span class="se">{{</span><span class="s2">Homogeneity</span><span class="se">}}</span><span class="s2">$, test of $\theta_i=\theta_j$, BD=</span><span class="si">{</span><span class="n">bd</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> $\bf</span><span class="se">{{</span><span class="s2">p=</span><span class="si">{</span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.001</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)(</span><span class="n">bd_pval</span><span class="p">)</span><span class="si">}</span><span class="se">}}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span>
                <span class="o">-</span><span class="mf">1.1</span><span class="p">,</span>
                <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">thresh_adjust</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_pval_less</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gaste_</span><span class="p">,</span> <span class="n">gaste_pval_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaste</span><span class="p">(</span><span class="s2">&quot;less&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gaste_</span><span class="p">,</span> <span class="n">gaste_pval_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_pval_less</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_pval_greater</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gaste</span><span class="p">,</span> <span class="n">gaste_pval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaste</span><span class="p">(</span><span class="s2">&quot;greater&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gaste</span><span class="p">,</span> <span class="n">gaste_pval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_pval_greater</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="sa">rf</span><span class="s2">&quot;$\bf</span><span class="se">{{</span><span class="s2">Overall\,effect,\,Stratified\,Exact\,test\,(GASTE)</span><span class="se">}}</span><span class="s2">$, $\#\it</span><span class="se">{{</span><span class="s2">supp</span><span class="se">}}</span><span class="s2">(Y)=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_combination</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">thresh_adjust</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)),</span>
            <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="sa">rf</span><span class="s2">&quot;test of $\forall i \, </span><span class="si">{</span><span class="n">print_theta_i</span><span class="si">}</span><span class="s2">\geq</span><span class="si">{</span><span class="n">center_val</span><span class="si">}</span><span class="s2">$, $Y_1^-$=</span><span class="si">{</span><span class="n">gaste_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, $\bf</span><span class="se">{{</span><span class="s2">p^-=</span><span class="si">{</span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.001</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)(</span><span class="n">gaste_pval_</span><span class="p">)</span><span class="si">}</span><span class="se">}}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">thresh_adjust</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)),</span>
            <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="sa">rf</span><span class="s2">&quot;test of $\forall i \, </span><span class="si">{</span><span class="n">print_theta_i</span><span class="si">}</span><span class="s2">\leq</span><span class="si">{</span><span class="n">center_val</span><span class="si">}</span><span class="s2">$, $Y_1^+$=</span><span class="si">{</span><span class="n">gaste</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, $\bf</span><span class="se">{{</span><span class="s2">p^+=</span><span class="si">{</span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.001</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)(</span><span class="n">gaste_pval</span><span class="p">)</span><span class="si">}</span><span class="se">}}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">thresh_adjust</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)),</span>
            <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">center_val</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">log_scale</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Log Odds Ratio&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Odds Ratio&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">pool_odd</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="n">df_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name_columns_data</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;$p_i^-$&quot;</span><span class="p">,</span> <span class="s2">&quot;$p_i^+$&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_rows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">row1</span><span class="p">,</span> <span class="n">row2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_rows</span>
            <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_columns</span>
            <span class="n">df_left</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.76</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="n">thresh_adjust</span><span class="p">),</span>
                <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.46</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="n">thresh_adjust</span><span class="p">),</span>
                <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">df_left</span><span class="p">[</span><span class="s2">&quot;$p_i^-$&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;$p_i^-$&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">df_left</span><span class="p">[</span><span class="s2">&quot;$p_i^+$&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;$p_i^+$&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.001</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">table_left</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">table</span><span class="p">(</span>
            <span class="n">ax</span><span class="p">,</span>
            <span class="n">df_left</span><span class="p">,</span>
            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">cellLoc</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.85</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="n">thresh_adjust</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">table_left</span><span class="o">.</span><span class="n">auto_set_font_size</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">table_left</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">table_left</span><span class="o">.</span><span class="n">get_celld</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_scale</span><span class="p">:</span>
            <span class="n">df_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;log(OR)&quot;</span><span class="p">,</span> <span class="s2">&quot;log(CI)&quot;</span><span class="p">,</span> <span class="s2">&quot;%W(fixed)&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df_right</span><span class="p">[</span><span class="s2">&quot;Log Odd ratio</span><span class="se">\n</span><span class="s2"> with 95% CI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odd</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="n">ci</span>
                <span class="k">for</span> <span class="n">odd</span><span class="p">,</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df_right</span><span class="p">[</span><span class="s2">&quot;log(OR)&quot;</span><span class="p">],</span> <span class="n">df_right</span><span class="p">[</span><span class="s2">&quot;log(CI)&quot;</span><span class="p">])</span>
            <span class="p">]</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;Log &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;OR&quot;</span><span class="p">,</span> <span class="s2">&quot;CI&quot;</span><span class="p">,</span> <span class="s2">&quot;%W(fixed)&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df_right</span><span class="p">[</span><span class="s2">&quot;Odd ratio</span><span class="se">\n</span><span class="s2"> with 95% CI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odd</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="n">ci</span>
                <span class="k">for</span> <span class="n">odd</span><span class="p">,</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df_right</span><span class="p">[</span><span class="s2">&quot;OR&quot;</span><span class="p">],</span> <span class="n">df_right</span><span class="p">[</span><span class="s2">&quot;CI&quot;</span><span class="p">])</span>
            <span class="p">]</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">df_right</span><span class="p">[</span><span class="s2">&quot;%W(fixed)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_right</span><span class="p">[</span><span class="s2">&quot;%W(fixed)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="n">df_right</span> <span class="o">=</span> <span class="n">df_right</span><span class="p">[[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">Odd ratio</span><span class="se">\n</span><span class="s2"> with 95% CI&quot;</span><span class="p">,</span> <span class="s2">&quot;%W(fixed)&quot;</span><span class="p">]]</span>
        <span class="n">df_right</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">df_right</span><span class="p">,</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">Odd ratio</span><span class="se">\n</span><span class="s2"> with 95% CI&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">pool_odd</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="p">)</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;  &quot;</span>
                        <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">ci_pool_odd_ratio_inf</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="p">)</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">ci_pool_odd_ratio_sup</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="p">)</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">decimal</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;%W(fixed)&quot;</span><span class="p">:</span> <span class="s2">&quot;100.0%&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">the_table_2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">table</span><span class="p">(</span>
            <span class="n">cellText</span><span class="o">=</span><span class="n">df_right</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">rowLabels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">colLabels</span><span class="o">=</span><span class="n">df_right</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">cellLoc</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="p">(</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="mf">0.6</span><span class="p">,</span>
                <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="n">thresh_adjust</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">colWidths</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">the_table_2</span><span class="o">.</span><span class="n">auto_set_font_size</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">the_table_2</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">the_table_2</span><span class="o">.</span><span class="n">get_celld</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="s2">&quot;.svg&quot;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Alexandre Wendling.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>